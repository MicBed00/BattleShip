<!DOCTYPE html>
<html lang="en" xmlns:th="https://www.thymeleaf.org" xmlns:https="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>Battle Ship add ship</title>
    <style>
        .tableResponse {
            border: 2px solid;
            background-color: blue;
            width: 400px;
        }
        .row {
            width: 50px;
            height: 30px;
            border: 1px solid;
        }
        .cell {
            width: 50px;
            height: 30px;
            border: 1px solid;
        }
        .button {
            height:23px;
            width:23px;
            background-color: blue;
        }
    </style>

</head>
<body>
<div align="center">
    <h1>Add Ship</h1>

    <label>Wielkość statku: </label>
    <select id="len" th:name="length">
        <option th:each="length :${shipSize}" th:value="${length}" th:text="${length}"></option>
    </select>

    <label>Orientacja: </label>
    <select id="orientation" th:name="position">
        <option th:each="o :${orientList}" th:value="${o}" th:text="${o}"></option>
    </select>
    <br>
    <br>
    <div id="renderTable"></div>
    <br>
    <br>
    <br>
    <button id="accept" style="height: 50px; width: 100px" value="0" disabled>Accept</button>
</div>

<script>
    window.onload = renderShip(null);
    function adderShip(event) {
        var length = document.getElementById("len").value;
        var position = document.getElementById("orientation").value;
        var xstart, ystart;
        var target = event.target, col, row;

        col = target.parentElement;
        row = col.parentElement;
        ystart = row.rowIndex;
        xstart = col.cellIndex;

        new BattleShipClient().addShip(length, xstart, ystart, position, (status, responseBody) => {
            if (status >= 200 && status <= 299) {
                renderShip(responseBody)
                document.getElementById("len").value = 1;
                document.getElementById("orientation").value = "VERTICAL";

                //wymyślić inny warunek dla odblokowania przycisku
                if(responseBody.length === 2) {
                    document.getElementById("accept").disabled = false;
                }
            }

        }, (status, responseBody) => {
            if (status >= 400 && status <= 499) {
                alert("Błąd użytkownika" + responseBody);
                location.replace("http://localhost:8080/startGame");
            } else if (status >= 500) {
                alert("Błąd serwera" + responseBody);
                location.replace("http://localhost:8080/startGame");
            }

        });

        document.getElementById("accept").addEventListener("click", function (event) {
            renderShip(null);

            let target = event.target;
            target.setAttribute("value", +target.value.valueOf()+ +1);      //sumowanie stringów gdy są liczbami. Zmieniam wartość value po to by w momencie zmiany list
                                                                            // (gracz1 dodał swoje statki, i serwer zaczyna podsyłać listę gracz2 - zmiana listy następuje w addShipToList() gameservice)
            document.getElementById("accept").disabled = true;

            if(target.value.valueOf() > 2) {
                window:location.replace("http://localhost:8080/addedShip");
            }
        },false);
    }

    function renderShip(responseBody) {
        const table = document.createElement("table");
        table.id = "tableRes";
        table.className = "tableResponse";
        const tbBody = document.createElement("tbody");

        for (let i = 0; i < 10; i++) {

            const row = document.createElement("tr");
            row.className = "row";

            for (let j = 0; j < 10; j++) {

                const cell = document.createElement("td");
                cell.className = "cell";
                // cell.innerHTML = "<button onclick=\"adderShip(event)\" style=\"height:23px;width:23px; background-color: blue\"></button> "
                const button = document.createElement("button");
                button.className = "button";
                button.id = i+","+j
                button.addEventListener("click", function(event) {
                    adderShip(event);
                }, false);
                cell.appendChild(button);

                if(responseBody != null) {
                    for(let k = 0; k < responseBody.length; k ++) {
                        if (responseBody[k].position.length === "HORIZONTAL".length) {

                            if (responseBody[k].ystart === i && responseBody[k].xstart >= j
                                && (responseBody[k].xstart - responseBody[k].length + 1) <= j)
                                // document.getElementById(i+","+j).style.backgroundColor = "yellow";  // nie działa - po kliknięciu cały board staję się żółty
                                cell.style.backgroundColor = "yellow";

                        } else {

                            if (responseBody[k].xstart === j && responseBody[k].ystart <= i
                                && (responseBody[k].ystart + responseBody[k].length - 1) >= i)
                                //  document.getElementById(i+","+j).style.backgroundColor = "yellow";
                                cell.style.backgroundColor = "yellow";
                        }
                    }
                }
                row.appendChild(cell);
            }
            tbBody.appendChild(row);
        }
        table.appendChild(tbBody);
        document.getElementById("renderTable").innerHTML = ""; // czyści diva
        document.getElementById("renderTable").appendChild(table);
    }

    class BattleShipClient {

        addShip(length, xstart, ystart, position, onSuccess, onError) {
            console.log("w addShip " + length + " " + xstart + " " + ystart + " " + position);
            this.post("/addShip", "length=" + length + "&xstart=" + xstart + "&ystart=" + ystart + "&position=" + position, null, onSuccess, onError);
        }

        delete(path, body, progressUpdate, success, error) {
            this.call("delete", path, body, progressUpdate, success, error);
        }


        post(path, body, progressUpdate, success, error) {
            console.log("w post " + body);
            this.call("post", path, body, progressUpdate, success, error);
        }

        call(method, path, body, progressUpdate, success, error) {
            let request = new XMLHttpRequest();
            request.upload.addEventListener('progress', function (event) {
                if (event.lengthComputable) {
                    let progress = event.loaded / event.total;
                    if (progressUpdate != null)
                        progressUpdate(progress);
                }
            }, false);

            request.onreadystatechange = function () {
                if (this.readyState === XMLHttpRequest.DONE)
                    if (this.status >= 200 && this.status <= 299) {
                        let body = this.responseText != null && this.responseText.length > 0 ? JSON.parse(this.responseText) : null; //tutaj dostaję odpowiedź z serwera tylko zamiast Json jest to html i muszę go jakos przetworzyć i podać do metody success
                        //let body = this.responseText;
                        success(this.status, body);
                    } else if (error !== undefined)
                        error(this.status, this.responseText);
            };
            request.open(method.toUpperCase(), path, true);
            request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded; charset=UTF-8');  //'application/json' - dla wysyłania jsona
            // var data = JSON.stringify(body); // zmiana danych na jsona
            request.send(body);
        }
    }
</script>
</body>
</html>

